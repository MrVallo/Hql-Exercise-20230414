# Hql-Exercise-20230414
hql刷题
# 1.男性和女性的购物总金额统计

## 题目需求

从订单信息表（order_info）和用户信息表（user_info）中，分别统计每天男性和女性用户的订单总金额，如果当天男性或者女性没有购物，则统计结果为0。

## 期望结果如下：

| create_date <string> （日期） | total_amount_male <decimal(16,2)> （男性用户总金额） | total_amount_female <decimal(16,2)> （女性用户总金额） |
| :---------------------------: | :--------------------------------------------------: | :----------------------------------------------------: |
|          2020-10-08           |                       51950.00                       |                        24020.00                        |
|          2021-09-27           |                       29000.00                       |                          0.00                          |
|          2021-09-28           |                       70500.00                       |                          0.00                          |
|          2021-09-29           |                       43300.00                       |                          0.00                          |
|          2021-09-30           |                        860.00                        |                          0.00                          |
|          2021-10-01           |                         0.00                         |                       171680.00                        |
|          2021-10-02           |                         0.00                         |                        76150.00                        |
|          2021-10-03           |                       89880.00                       |                        5910.00                         |
|          2021-10-04           |                       9390.00                        |                       120100.00                        |
|          2021-10-05           |                      109760.00                       |                        69850.00                        |
|          2021-10-06           |                      101070.00                       |                        54300.00                        |
|          2021-10-07           |                       54700.00                       |                       129480.00                        |

## 需要用到的表：

**订单信息表：order_info**

| **order_id** (订单id) | **user_id** (用户id) | **create_date** (下单日期) | **total_amount** (订单金额) |
| --------------------- | -------------------- | -------------------------- | --------------------------- |
| 1                     | 101                  | 2021-09-30                 | 29000.00                    |
| 10                    | 103                  | 2020-10-02                 | 28000.00                    |

**用户信息表：user_info**

| user_id(用户id) | gender(性别) | birthday(生日) |
| --------------- | ------------ | -------------- |
| 101             | 男           | 1990-01-01     |
| 102             | 女           | 1991-02-01     |
| 103             | 女           | 1992-03-01     |
| 104             | 男           | 1993-04-01     |

## 思路

按照create_date分组，聚合求总金额

## 代码

```sql
SELECT
  create_date,
  sum(IF (gender = '男', total_amount, 0)) total_amount_male,
  sum(IF (gender = '女', total_amount, 0)) total_amount_female
FROM
  order_info t1
  JOIN user_info t2 ON t1.user_id = t2.user_id
GROUP BY
  create_date
```

# 2.即时订单比例

## 题目需求

订单配送中，如果期望配送日期和下单日期相同，称为即时订单，如果期望配送日期和下单日期不同，称为计划订单。
请从配送信息表（delivery_info）中求出每个用户的首单（用户的第一个订单）中即时订单的比例，保留两位小数，以小数形式显示。

## 期望结果如下：

| percentage <decimal(16,2)> |
| :------------------------: |
|            0.50            |

## 需要用到的表：

**配送信息表：delivery_info**

| delivery_id （运单 ***\*id\**** ） | order_id （订单id） | user_id （用户 id ） | order_date （下单日期） | custom_date （期望配送日期） |
| ---------------------------------- | ------------------- | -------------------- | ----------------------- | ---------------------------- |
| **1**                              | 1                   | 101                  | 2021-09-27              | 2021-09-29                   |
| **2**                              | 2                   | 101                  | 2021-09-28              | 2021-09-28                   |
| **3**                              | 3                   | 101                  | 2021-09-29              | 2021-09-30                   |

## 代码

```sql
select
  (cast((c2 / c1) as DECIMAL(10, 2))) percentage
from
  (
    select
      count(distinct user_id) c1,
      count(if (custom_date = f_v, 1, null)) c2
    from
      (
       select distinct
          user_id,
          first_value (order_date) over (
            partition by
              user_id
            order by
              order_date
          ) f_v,
          custom_date
        from
          delivery_info
          ) t1
      ) t2
  ) t3
```

# 3.查询用户的累积消费金额及VIP等级

## 题目需求：

从订单信息表(order_info)中统计每个用户截止其每个下单日期的累积消费金额，以及每个用户在其每个下单日期的VIP等级。
用户vip等级根据累积消费金额计算，计算规则如下：
设累积消费总额为X，
若0=<X<10000,则vip等级为普通会员
若10000<=X<30000,则vip等级为青铜会员
若30000<=X<50000,则vip等级为白银会员
若50000<=X<80000,则vip为黄金会员
若80000<=X<100000,则vip等级为白金会员
若X>=100000,则vip等级为钻石会员

## 期望结果如下：

| user_id <string> (用户id) | create_date <string> (下单日期) | sum_so_far <decimal(16,2)> (截至每个下单日期的累计下单金额) | vip_level <string> (每个下单日期的VIP等级) |
| ------------------------- | ------------------------------- | ----------------------------------------------------------- | ------------------------------------------ |
| 101                       | 2021-09-27                      | 29000.00                                                    | 青铜会员                                   |
| 101                       | 2021-09-28                      | 99500.00                                                    | 白金会员                                   |
| 101                       | 2021-09-29                      | 142800.00                                                   | 钻石会员                                   |
| 101                       | 2021-09-30                      | 143660.00                                                   | 钻石会员                                   |
| 102                       | 2021-10-01                      | 171680.00                                                   | 钻石会员                                   |
| 102                       | 2021-10-02                      | 177850.00                                                   | 钻石会员                                   |
| 103                       | 2021-10-02                      | 69980.00                                                    | 黄金会员                                   |
| 103                       | 2021-10-03                      | 75890.00                                                    | 黄金会员                                   |
| 104                       | 2021-10-03                      | 89880.00                                                    | 白金会员                                   |
| 105                       | 2021-10-04                      | 120100.00                                                   | 钻石会员                                   |
| 106                       | 2021-10-04                      | 9390.00                                                     | 普通会员                                   |
| 106                       | 2021-10-05                      | 119150.00                                                   | 钻石会员                                   |
| 107                       | 2021-10-05                      | 69850.00                                                    | 黄金会员                                   |
| 107                       | 2021-10-06                      | 124150.00                                                   | 钻石会员                                   |
| 108                       | 2021-10-06                      | 101070.00                                                   | 钻石会员                                   |
| 108                       | 2021-10-07                      | 155770.00                                                   | 钻石会员                                   |
| 109                       | 2020-10-08                      | 24020.00                                                    | 青铜会员                                   |
| 109                       | 2021-10-07                      | 153500.00                                                   | 钻石会员                                   |
| 1010                      | 2020-10-08                      | 51950.00                                                    | 黄金会员                                   |

## 需要用到的表：

**订单信息表：order_info**

| **order_id** (订单id) | **user_id** (用户id) | **create_date** (下单日期) | **total_amount** (订单金额) |
| --------------------- | -------------------- | -------------------------- | --------------------------- |
| 1                     | 101                  | 2021-09-30                 | 29000.00                    |
| 10                    | 103                  | 2020-10-02                 | 28000.00                    |

## 代码

```sql
select
  user_id,
  create_date,
  sum_so_far,
  case
    when sum_so_far >= 0
    and sum_so_far < 10000 then '普通会员'
    when sum_so_far >= 10000
    and sum_so_far < 30000 then '青铜会员'
    when sum_so_far >= 30000
    and sum_so_far < 50000 then '白银会员'
    when sum_so_far >= 50000
    and sum_so_far < 80000 then '黄金会员'
    when sum_so_far >= 80000
    and sum_so_far < 100000 then '白金会员'
    when sum_so_far >= 100000 then '钻石会员'
  end vip_level
from
  (
    select
      user_id,
      create_date,
      sum(total_amount) over (partition by user_id order by create_date) sum_so_far
    from
      order_info
  ) t1
group by
  user_id,
  create_date,
  sum_so_far
```
# 4.统计每个商品销售首年的年份，销售数量和销售总额

## 题目需求：

从订单明细表(order_detail)统计每个商品销售首年的年份，销售数量和销售总额。

## 期望结果如下：

| sku_id <string> (商品id) | year <bigint> (销售首年年份) | order_num <bigint> (首年销量) | order_amount <decimal(16,2)> (首年销售金额) |
| :----------------------: | :--------------------------: | :---------------------------: | :-----------------------------------------: |
|            1             |             2020             |               2               |                   4000.00                   |
|            2             |             2020             |              26               |                   260.00                    |
|            3             |             2020             |               1               |                   5000.00                   |
|            4             |             2021             |              53               |                  318000.00                  |
|            5             |             2021             |              242              |                  121000.00                  |
|            6             |             2020             |               6               |                  12000.00                   |
|            7             |             2020             |              35               |                   3500.00                   |
|            8             |             2020             |              59               |                  35400.00                   |
|            9             |             2021             |              194              |                  194000.00                  |
|            10            |             2020             |              94               |                   9400.00                   |
|            11            |             2020             |              95               |                   4750.00                   |
|            12            |             2020             |              83               |                   1660.00                   |

## 需要用到的表：

**订单明细表：order_detail**

| order_detail_id(订单明细id) | order_id(订单id) | sku_id(商品id) | create_date(下单日期) | price(商品单价) | sku_num(商品件数) |
| --------------------------- | ---------------- | -------------- | --------------------- | --------------- | ----------------- |
| 1                           | **1**            | **1**          | **2021-09-30**        | **2000.00**     | **2**             |
| 2                           | **1**            | **3**          | **2021-09-30**        | **5000.00**     | **5**             |
| 22                          | **10**           | **4**          | **2020-10-02**        | **6000.00**     | **1**             |
| 23                          | **10**           | **5**          | **2020-10-02**        | **500.00**      | **24**            |
| 24                          | **10**           | **6**          | **2020-10-02**        | **2000.00**     | **5**             |

## 代码

```sql
select
  sku_id,
  year (first_year) `year`,
  sum(sku_num) order_num,
  sum(sku_num) * price order_amount
from
  (
    select
      *
    from
      (
        select
          *,
          first_value (create_date) over (
            partition by
              sku_id
            order by
              create_date
          ) first_year
        from
          order_detail
      ) t1
    where
      year (first_year) = year (create_date)
  ) t2
group by
  sku_id,
  year (first_year),
  price
```




